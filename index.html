<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Game 3D Iklan Arena</title>
  <style>
    body { margin: 0; overflow: hidden; background: #000; }
    canvas { display: block; }
    #hud {
      position: absolute;
      top: 10px;
      left: 10px;
      color: white;
      font-family: monospace;
      font-size: 14px;
      background: rgba(0,0,0,0.5);
      padding: 6px 10px;
      border-radius: 6px;
    }
    #startBtn {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      padding: 15px 25px;
      background: #00cc88;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="hud">
    Klik layar untuk lock mouse. <br>
    W/A/S/D = Gerak â€¢ Spasi = Play/Pause Video
  </div>
  <button id="startBtn">Klik untuk Mulai</button>

  <!-- Three.js & Controls -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/PointerLockControls.js"></script>

  <script>
    let scene, camera, renderer, controls;
    let moveForward=false, moveBackward=false, moveLeft=false, moveRight=false;
    let direction = new THREE.Vector3();
    let objects = []; // untuk collision
    let videoPlaying = true;

    init();
    animate();

    function init(){
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
      camera.position.set(0, 2, 10);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      // Controls
      controls = new THREE.PointerLockControls(camera, document.body);
      const startBtn = document.getElementById("startBtn");
      startBtn.addEventListener("click", ()=>{
        controls.lock();
      });
      controls.addEventListener("lock", ()=>{ startBtn.style.display="none"; });
      controls.addEventListener("unlock", ()=>{ startBtn.style.display="block"; });

      // Lights
      const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 1);
      hemi.position.set(0, 20, 0);
      scene.add(hemi);
      const dir = new THREE.DirectionalLight(0xffffff, 0.8);
      dir.position.set(5,10,7.5);
      scene.add(dir);

      // Ground (track)
      const ground = new THREE.Mesh(
        new THREE.PlaneGeometry(20, 200),
        new THREE.MeshPhongMaterial({ color: 0x333333 })
      );
      ground.rotation.x = -Math.PI/2;
      scene.add(ground);

      // Pagar kiri kanan
      const fenceMat = new THREE.MeshPhongMaterial({ color: 0x555555 });
      const fenceGeo = new THREE.BoxGeometry(1, 3, 200);
      const leftFence = new THREE.Mesh(fenceGeo, fenceMat);
      leftFence.position.set(-10.5, 1.5, 0);
      scene.add(leftFence); objects.push(leftFence);

      const rightFence = new THREE.Mesh(fenceGeo, fenceMat);
      rightFence.position.set(10.5, 1.5, 0);
      scene.add(rightFence); objects.push(rightFence);

      // Video Wall kiri & kanan
      createVideoWall("video1.mp4", -9, 0);
      createVideoWall("video2.mp4", 9, 0);

      // Controls input
      document.addEventListener("keydown", onKeyDown);
      document.addEventListener("keyup", onKeyUp);

      window.addEventListener("resize", onWindowResize);
    }

    function createVideoWall(src, x, z){
      const video = document.createElement("video");
      video.src = src;
      video.loop = true;
      video.muted = true;
      video.autoplay = true;
      video.play();

      const texture = new THREE.VideoTexture(video);
      const material = new THREE.MeshBasicMaterial({ map: texture, side: THREE.DoubleSide });

      const wall = new THREE.Mesh(new THREE.PlaneGeometry(16, 9), material);
      wall.position.set(x, 4.5, z-30); // agak di depan
      wall.rotation.y = x > 0 ? -Math.PI/2 : Math.PI/2;
      scene.add(wall);
      objects.push(wall);
    }

    function onKeyDown(e){
      switch(e.code){
        case "KeyW": case "ArrowUp": moveForward=true; break;
        case "KeyS": case "ArrowDown": moveBackward=true; break;
        case "KeyA": case "ArrowLeft": moveLeft=true; break;
        case "KeyD": case "ArrowRight": moveRight=true; break;
        case "Space":
          videoPlaying = !videoPlaying;
          document.querySelectorAll("video").forEach(v=>{
            if(videoPlaying) v.play(); else v.pause();
          });
          break;
      }
    }
    function onKeyUp(e){
      switch(e.code){
        case "KeyW": case "ArrowUp": moveForward=false; break;
        case "KeyS": case "ArrowDown": moveBackward=false; break;
        case "KeyA": case "ArrowLeft": moveLeft=false; break;
        case "KeyD": case "ArrowRight": moveRight=false; break;
      }
    }

    function onWindowResize(){
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function detectCollision(offsetX, offsetZ){
      const raycaster = new THREE.Raycaster();
      const pos = controls.getObject().position.clone();
      const dir = new THREE.Vector3(offsetX, 0, offsetZ).normalize();
      raycaster.set(pos, dir);
      const intersects = raycaster.intersectObjects(objects, true);
      return intersects.length > 0 && intersects[0].distance < 1;
    }

    function animate(){
      requestAnimationFrame(animate);

      if(controls.isLocked){
        let moveX=0, moveZ=0;
        direction.z = Number(moveForward) - Number(moveBackward);
        direction.x = Number(moveRight) - Number(moveLeft);
        direction.normalize();

        if(moveForward || moveBackward) moveZ = direction.z * 0.2;
        if(moveLeft || moveRight) moveX = direction.x * 0.2;

        if(!detectCollision(moveX, moveZ)){
          controls.moveRight(moveX);
          controls.moveForward(moveZ);
        }
      }

      renderer.render(scene, camera);
    }
  </script>
</body>
</html>
